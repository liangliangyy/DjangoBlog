name: Frontend CI

on:
  push:
    branches:
      - master
      - dev
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  pull_request:
    branches:
      - master
      - dev
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    name: Frontend Build & Validation (Node ${{ matrix.node-version }})

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # ç¼“å­˜node_modules
      - name: ç¼“å­˜Nodeæ¨¡å—
        uses: actions/cache@v5
        with:
          path: |
            frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ– (Node ${{ matrix.node-version }})"
          npm ci

          # éªŒè¯å…³é”®ä¾èµ–
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–"
          npm list alpinejs
          npm list htmx.org
          npm list tailwindcss
          npm list vite

      - name: æ„å»ºå‰ç«¯èµ„æº
        working-directory: ./frontend
        run: |
          echo "ğŸ”¨ æ„å»ºå‰ç«¯èµ„æº"
          npm run build

          # éªŒè¯æ„å»ºäº§ç‰©
          echo "âœ… éªŒè¯æ„å»ºäº§ç‰©"
          ls -lh ../blog/static/blog/dist/

          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "../blog/static/blog/dist/.vite/manifest.json" ]; then
            echo "âŒ manifest.json ä¸å­˜åœ¨"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰CSSæ–‡ä»¶
          css_files=$(find ../blog/static/blog/dist/css -name "*.css" | wc -l)
          if [ "$css_files" -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°CSSæ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° $css_files ä¸ªCSSæ–‡ä»¶"

          # æ£€æŸ¥æ˜¯å¦æœ‰JSæ–‡ä»¶
          js_files=$(find ../blog/static/blog/dist/js -name "*.js" | wc -l)
          if [ "$js_files" -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°JSæ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° $js_files ä¸ªJSæ–‡ä»¶"

      - name: æ£€æŸ¥æ–‡ä»¶å¤§å°
        working-directory: ./frontend
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°"

          # è·å–CSSæ–‡ä»¶å¤§å°
          css_file=$(find ../blog/static/blog/dist/css -name "main-*.css" | head -1)
          if [ -f "$css_file" ]; then
            css_size=$(stat -c%s "$css_file")
            css_size_kb=$((css_size / 1024))
            echo "   CSSå¤§å°: ${css_size_kb}KB"

            # CSSæ–‡ä»¶å¤§å°è­¦å‘Šé˜ˆå€¼ (200KB)
            if [ "$css_size_kb" -gt 200 ]; then
              echo "âš ï¸  è­¦å‘Š: CSSæ–‡ä»¶è¾ƒå¤§ (${css_size_kb}KB)"
            fi
          fi

          # è·å–JSæ–‡ä»¶æ€»å¤§å°
          js_total_size=$(find ../blog/static/blog/dist/js -name "*.js" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
          js_total_kb=$((js_total_size / 1024))
          echo "   JSæ€»å¤§å°: ${js_total_kb}KB"

          # JSæ–‡ä»¶å¤§å°è­¦å‘Šé˜ˆå€¼ (200KB)
          if [ "$js_total_kb" -gt 200 ]; then
            echo "âš ï¸  è­¦å‘Š: JSæ–‡ä»¶è¾ƒå¤§ (${js_total_kb}KB)"
          fi

      - name: éªŒè¯CSSè¯­æ³•
        working-directory: ./frontend
        run: |
          echo "ğŸ¨ éªŒè¯CSSæ–‡ä»¶"

          # æ£€æŸ¥CSSæ–‡ä»¶æ˜¯å¦åŒ…å«å…³é”®é€‰æ‹©å™¨
          css_file=$(find ../blog/static/blog/dist/css -name "main-*.css" | head -1)

          if [ -f "$css_file" ]; then
            echo "âœ… æ£€æŸ¥CSSå…³é”®é€‰æ‹©å™¨"

            # æ£€æŸ¥æ·±è‰²æ¨¡å¼æ”¯æŒ
            if grep -q "data-theme=dark" "$css_file"; then
              echo "   âœ… åŒ…å«æ·±è‰²æ¨¡å¼æ”¯æŒ"
            else
              echo "   âŒ ç¼ºå°‘æ·±è‰²æ¨¡å¼æ”¯æŒ"
              exit 1
            fi

            # æ£€æŸ¥TailwindåŸºç¡€ç±»
            if grep -q "@tailwind" "$css_file" || grep -q "tailwind" "$css_file" || grep -q ".container" "$css_file"; then
              echo "   âœ… åŒ…å«Tailwind CSS"
            else
              echo "   âš ï¸  å¯èƒ½ç¼ºå°‘Tailwind CSS"
            fi

            # æ£€æŸ¥ä»£ç å—æ ·å¼
            if grep -q "codehilite" "$css_file" || grep -q "code" "$css_file"; then
              echo "   âœ… åŒ…å«ä»£ç å—æ ·å¼"
            else
              echo "   âš ï¸  å¯èƒ½ç¼ºå°‘ä»£ç å—æ ·å¼"
            fi
          fi

      - name: éªŒè¯JSè¯­æ³•
        working-directory: ./frontend
        run: |
          echo "ğŸ” éªŒè¯JSæ–‡ä»¶"

          # æ£€æŸ¥ä¸»JSæ–‡ä»¶
          main_js=$(find ../blog/static/blog/dist/js -name "main-*.js" | head -1)

          if [ -f "$main_js" ]; then
            echo "âœ… æ£€æŸ¥JSæ¨¡å—"

            # æ£€æŸ¥Alpine.js
            if grep -q "Alpine" "$main_js" || [ -f "$(find ../blog/static/blog/dist/js -name "alpine-*.js" | head -1)" ]; then
              echo "   âœ… åŒ…å«Alpine.js"
            else
              echo "   âŒ ç¼ºå°‘Alpine.js"
              exit 1
            fi

            # æ£€æŸ¥HTMX
            if grep -q "htmx" "$main_js" || [ -f "$(find ../blog/static/blog/dist/js -name "htmx-*.js" | head -1)" ]; then
              echo "   âœ… åŒ…å«HTMX"
            else
              echo "   âŒ ç¼ºå°‘HTMX"
              exit 1
            fi
          fi

      - name: æ£€æŸ¥manifest.json
        working-directory: ./frontend
        run: |
          echo "ğŸ“‹ éªŒè¯Vite manifest"

          manifest="../blog/static/blog/dist/.vite/manifest.json"
          if [ -f "$manifest" ]; then
            echo "âœ… manifest.json å­˜åœ¨"

            # éªŒè¯JSONæ ¼å¼
            if jq empty "$manifest" 2>/dev/null; then
              echo "   âœ… JSONæ ¼å¼æ­£ç¡®"

              # æ˜¾ç¤ºå…¥å£ç‚¹
              echo "   ğŸ“ å…¥å£ç‚¹:"
              jq -r 'keys[]' "$manifest" | sed 's/^/      - /'
            else
              echo "   âŒ JSONæ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ manifest.json ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æ„å»ºç»Ÿè®¡
        if: always()
        working-directory: ./frontend
        run: |
          echo "ğŸ“Š ============ æ„å»ºç»Ÿè®¡ ============"
          echo "   ğŸ·ï¸  Nodeç‰ˆæœ¬: ${{ matrix.node-version }}"
          echo "   ğŸ“¦ æ„å»ºçŠ¶æ€: ${{ job.status }}"

          # æ–‡ä»¶ç»Ÿè®¡
          if [ -d "../blog/static/blog/dist/" ]; then
            total_size=$(du -sh ../blog/static/blog/dist/ | cut -f1)
            file_count=$(find ../blog/static/blog/dist/ -type f | wc -l)
            echo "   ğŸ“ æ€»æ–‡ä»¶æ•°: $file_count"
            echo "   ğŸ’¾ æ€»å¤§å°: $total_size"
          fi

          echo "   ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"

          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ å‰ç«¯æ„å»ºæˆåŠŸï¼"
          else
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„æ—¥å¿—"
          fi
