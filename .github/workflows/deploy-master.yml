name: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

on:
  workflow_run:
    workflows: ["Django CI"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      image_tag:
        description: 'é•œåƒæ ‡ç­¾ (é»˜è®¤: latest)'
        required: false
        default: 'latest'
        type: string
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ç›´æ¥éƒ¨ç½²'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.cn-shenzhen.aliyuncs.com
  IMAGE_NAME: liangliangyy/djangoblog
  NAMESPACE: djangoblog

jobs:
  deploy:
    name: æ„å»ºé•œåƒå¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®éƒ¨ç½²å‚æ•°
      id: deploy-params
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "trigger_type=æ‰‹åŠ¨è§¦å‘" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          echo "skip_tests=${{ github.event.inputs.skip_tests }}" >> $GITHUB_OUTPUT
        else
          echo "trigger_type=CIè‡ªåŠ¨è§¦å‘" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "image_tag=latest" >> $GITHUB_OUTPUT
          echo "skip_tests=false" >> $GITHUB_OUTPUT
        fi
        
    - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      run: |
        echo "ğŸš€ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "   è§¦å‘æ–¹å¼: ${{ steps.deploy-params.outputs.trigger_type }}"
        echo "   éƒ¨ç½²ç¯å¢ƒ: ${{ steps.deploy-params.outputs.environment }}"
        echo "   é•œåƒæ ‡ç­¾: ${{ steps.deploy-params.outputs.image_tag }}"
        echo "   è·³è¿‡æµ‹è¯•: ${{ steps.deploy-params.outputs.skip_tests }}"
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•ç§æœ‰é•œåƒä»“åº“
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        
    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=${{ steps.deploy-params.outputs.image_tag }}
          
    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: ${{ secrets.PRODUCTION_PORT || 22 }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² DjangoBlog..."
          
          # æ£€æŸ¥kubectlæ˜¯å¦å¯ç”¨
          if ! command -v kubectl &> /dev/null; then
            echo "âŒ é”™è¯¯: kubectl æœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­"
            exit 1
          fi
          
          # æ£€æŸ¥å‘½åç©ºé—´æ˜¯å¦å­˜åœ¨
          if ! kubectl get namespace ${{ env.NAMESPACE }} &> /dev/null; then
            echo "âŒ é”™è¯¯: å‘½åç©ºé—´ ${{ env.NAMESPACE }} ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ›´æ–°deploymenté•œåƒ
          echo "ğŸ“¦ æ›´æ–°deploymenté•œåƒä¸º: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.deploy-params.outputs.image_tag }}"
          kubectl set image deployment/djangoblog \
            djangoblog=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.deploy-params.outputs.image_tag }} \
            -n ${{ env.NAMESPACE }}
          
          # é‡å¯deployment
          echo "ğŸ”„ é‡å¯deployment..."
          kubectl -n ${{ env.NAMESPACE }} rollout restart deployment djangoblog
          
          # ç­‰å¾…deploymentå®Œæˆ
          echo "â³ ç­‰å¾…deploymentå®Œæˆ..."
          kubectl rollout status deployment/djangoblog -n ${{ env.NAMESPACE }} --timeout=300s
          
          # æ£€æŸ¥deploymentçŠ¶æ€
          echo "âœ… æ£€æŸ¥deploymentçŠ¶æ€..."
          kubectl get deployment djangoblog -n ${{ env.NAMESPACE }}
          kubectl get pods -l app=djangoblog -n ${{ env.NAMESPACE }}
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        # è®¾ç½®é€šçŸ¥å†…å®¹
        if [ "${{ job.status }}" = "success" ]; then
          TITLE="âœ… DjangoBlogéƒ¨ç½²æˆåŠŸ"
          STATUS="æˆåŠŸ"
        else
          TITLE="âŒ DjangoBlogéƒ¨ç½²å¤±è´¥"
          STATUS="å¤±è´¥"
        fi
        
        MESSAGE="éƒ¨ç½²çŠ¶æ€: ${STATUS}
        è§¦å‘æ–¹å¼: ${{ steps.deploy-params.outputs.trigger_type }}
        éƒ¨ç½²ç¯å¢ƒ: ${{ steps.deploy-params.outputs.environment }}
        é•œåƒæ ‡ç­¾: ${{ steps.deploy-params.outputs.image_tag }}
        æäº¤è€…: ${{ github.actor }}
        æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        
        æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # å‘é€Serveré…±é€šçŸ¥
        if [ -n "${{ secrets.SERVERCHAN_KEY }}" ]; then
          echo "{\"title\": \"${TITLE}\", \"desp\": \"${MESSAGE}\"}" > /tmp/serverchan.json
          
          curl --location "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send" \
            --header "Content-Type: application/json" \
            --data @/tmp/serverchan.json \
            --silent > /dev/null
          
          rm -f /tmp/serverchan.json
          echo "ğŸ“± éƒ¨ç½²é€šçŸ¥å·²å‘é€"
        fi