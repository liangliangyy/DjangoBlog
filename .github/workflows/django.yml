name: Django CI

on:
  push:
    branches:
      - master
      - dev
    paths-ignore:
      - '**/*.md'
      - '**/*.css'
      - '**/*.js'
  pull_request:
    branches:
      - master
      - dev
    paths-ignore:
      - '**/*.md'
      - '**/*.css'
      - '**/*.js'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  duplicate-check:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          skip_after_successful_duplicate: 'true'
          paths_ignore: '["**/*.md", "docs/**"]'
          do_not_skip: '["workflow_dispatch", "schedule"]'
          concurrent_skipping: 'same_content_newer'
          cancel_others: 'true'

  test:
    needs: duplicate-check
    if: needs.duplicate-check.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # æ ‡å‡†æµ‹è¯• - Python 3.10
          - python-version: "3.10"
            test-type: "standard"
            database: "mysql"
            elasticsearch: false
            coverage: false
            
          # æ ‡å‡†æµ‹è¯• - Python 3.11  
          - python-version: "3.11"
            test-type: "standard" 
            database: "mysql"
            elasticsearch: false
            coverage: false
            
          # å®Œæ•´æµ‹è¯• - åŒ…å«ESå’Œè¦†ç›–ç‡
          - python-version: "3.11"
            test-type: "full"
            database: "mysql"
            elasticsearch: true
            coverage: true
            
          # Dockeræ„å»ºæµ‹è¯•
          - python-version: "3.11"
            test-type: "docker"
            database: "none"
            elasticsearch: false
            coverage: false

    name: Test (${{ matrix.test-type }}, Python ${{ matrix.python-version }})
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v6
        
      - name: è®¾ç½®æµ‹è¯•ä¿¡æ¯
        id: test-info
        run: |
          echo "test_name=${{ matrix.test-type }}-py${{ matrix.python-version }}" >> $GITHUB_OUTPUT
          if [ "${{ matrix.test-type }}" = "docker" ]; then
            echo "skip_python_setup=true" >> $GITHUB_OUTPUT
          else
            echo "skip_python_setup=false" >> $GITHUB_OUTPUT
          fi
          
      # MySQLæ•°æ®åº“è®¾ç½® (åªæœ‰éœ€è¦æ•°æ®åº“çš„æµ‹è¯•æ‰æ‰§è¡Œ)
      - name: å¯åŠ¨MySQLæ•°æ®åº“
        if: matrix.database == 'mysql'
        uses: samin/mysql-action@v1.3
        with:
          host port: 3306
          container port: 3306
          character set server: utf8mb4
          collation server: utf8mb4_general_ci
          mysql version: latest
          mysql root password: root
          mysql database: djangoblog
          mysql user: root
          mysql password: root
          
      # Elasticsearchè®¾ç½® (åªæœ‰å®Œæ•´æµ‹è¯•æ‰æ‰§è¡Œ)
      - name: é…ç½®ç³»ç»Ÿå‚æ•° (ES)
        if: matrix.elasticsearch == true
        run: |
          sudo swapoff -a
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w fs.file-max=262144
          sudo sysctl -w vm.max_map_count=262144
          
      - name: å¯åŠ¨Elasticsearch
        if: matrix.elasticsearch == true
        run: |
          echo "ğŸš€ å¯åŠ¨ Elasticsearch 8.6.1 å®¹å™¨"

          # å¯åŠ¨ Elasticsearch å®¹å™¨
          docker run -d \
            --name elasticsearch \
            -p 9200:9200 \
            -p 9300:9300 \
            -e "discovery.type=single-node" \
            -e "xpack.security.enabled=false" \
            -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
            elasticsearch:8.6.1

          # ç­‰å¾… Elasticsearch å¯åŠ¨
          echo "â³ ç­‰å¾… Elasticsearch å¯åŠ¨..."
          for i in {1..60}; do
            if curl -s http://localhost:9200 > /dev/null; then
              echo "âœ… Elasticsearch å¯åŠ¨æˆåŠŸ"
              curl -s http://localhost:9200

              # å®‰è£… IK åˆ†è¯å™¨
              echo "ğŸ“¦ å®‰è£… IK åˆ†è¯å™¨æ’ä»¶..."
              docker exec elasticsearch elasticsearch-plugin install --batch \
                https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.6.1.zip

              # é‡å¯ Elasticsearch
              echo "ğŸ”„ é‡å¯ Elasticsearch ä»¥åŠ è½½æ’ä»¶..."
              docker restart elasticsearch
              sleep 10

              # ç­‰å¾…é‡å¯å®Œæˆ
              for j in {1..30}; do
                if curl -s http://localhost:9200 > /dev/null; then
                  echo "âœ… Elasticsearch é‡å¯æˆåŠŸ"
                  break
                fi
                echo "ğŸ”„ ç­‰å¾… Elasticsearch é‡å¯... ($j/30)"
                sleep 2
              done

              break
            fi
            echo "ğŸ”„ ç­‰å¾… Elasticsearch å¯åŠ¨... ($i/60)"
            sleep 2
          done
          
      # Pythonç¯å¢ƒè®¾ç½® (Dockeræµ‹è¯•è·³è¿‡)
      - name: è®¾ç½®Python ${{ matrix.python-version }}
        if: steps.test-info.outputs.skip_python_setup == 'false'
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      # å¤šå±‚ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
      - name: ç¼“å­˜Pythonä¾èµ–
        if: steps.test-info.outputs.skip_python_setup == 'false'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            .pytest_cache
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}-
            ${{ runner.os }}-python-${{ matrix.python-version }}-
            ${{ runner.os }}-python-
            
      # Djangoç¼“å­˜ä¼˜åŒ– (æµ‹è¯•æ•°æ®åº“ç­‰)
      - name: ç¼“å­˜Djangoèµ„æº
        if: matrix.test-type != 'docker'
        uses: actions/cache@v5
        with:
          path: |
            .coverage*
            htmlcov/
            .django_cache/
          key: ${{ runner.os }}-django-${{ matrix.test-type }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-django-${{ matrix.test-type }}-
            ${{ runner.os }}-django-
            
      - name: å®‰è£…Pythonä¾èµ–
        if: steps.test-info.outputs.skip_python_setup == 'false'
        run: |
          echo "ğŸ“¦ å®‰è£…Pythonä¾èµ– (Python ${{ matrix.python-version }})"
          python -m pip install --upgrade pip setuptools wheel
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          pip install -r requirements.txt
          
          # æ ¹æ®æµ‹è¯•ç±»å‹å®‰è£…é¢å¤–ä¾èµ–
          if [ "${{ matrix.coverage }}" = "true" ]; then
            echo "ğŸ“Š å®‰è£…è¦†ç›–ç‡å·¥å…·"
            pip install coverage[toml]
          fi
          
          # éªŒè¯å…³é”®ä¾èµ–
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–å®‰è£…"
          python -c "import django; print(f'Django version: {django.get_version()}')"
          python -c "import MySQLdb; print('MySQL client: OK')" || python -c "import pymysql; print('PyMySQL client: OK')"
          
          if [ "${{ matrix.elasticsearch }}" = "true" ]; then
            python -c "import elasticsearch; print('Elasticsearch client: OK')"
          fi
          
      # Djangoç¯å¢ƒå‡†å¤‡
      - name: å‡†å¤‡Djangoç¯å¢ƒ
        if: matrix.test-type != 'docker'
        env:
          DJANGO_MYSQL_PASSWORD: root
          DJANGO_MYSQL_HOST: 127.0.0.1
          DJANGO_ELASTICSEARCH_HOST: ${{ matrix.elasticsearch && 'http://127.0.0.1:9200' || '' }}
        run: |
          echo "ğŸ”§ å‡†å¤‡Djangoæµ‹è¯•ç¯å¢ƒ"
          
          # ç­‰å¾…æ•°æ®åº“å°±ç»ª
          echo "â³ ç­‰å¾…MySQLæ•°æ®åº“å¯åŠ¨..."
          for i in {1..30}; do
            if python -c "import MySQLdb; MySQLdb.connect(host='127.0.0.1', user='root', passwd='root', db='djangoblog')" 2>/dev/null; then
              echo "âœ… MySQLæ•°æ®åº“è¿æ¥æˆåŠŸ"
              break
            fi
            echo "ğŸ”„ ç­‰å¾…æ•°æ®åº“å¯åŠ¨... ($i/30)"
            sleep 2
          done
          
          # ç­‰å¾…Elasticsearchå°±ç»ª (å¦‚æœå¯ç”¨)
          if [ "${{ matrix.elasticsearch }}" = "true" ]; then
            echo "â³ ç­‰å¾…Elasticsearchå¯åŠ¨..."
            for i in {1..30}; do
              if curl -s http://127.0.0.1:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; then
                echo "âœ… Elasticsearchè¿æ¥æˆåŠŸ"
                break
              fi
              echo "ğŸ”„ ç­‰å¾…Elasticsearchå¯åŠ¨... ($i/30)"
              sleep 2
            done
          fi
          
      # Djangoæµ‹è¯•æ‰§è¡Œ
      - name: æ‰§è¡Œæ•°æ®åº“è¿ç§»
        if: matrix.test-type != 'docker'
        env:
          DJANGO_MYSQL_PASSWORD: root
          DJANGO_MYSQL_HOST: 127.0.0.1
          DJANGO_ELASTICSEARCH_HOST: ${{ matrix.elasticsearch && 'http://127.0.0.1:9200' || '' }}
        run: |
          echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»"
          
          # æ£€æŸ¥è¿ç§»æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥å¾…åº”ç”¨çš„è¿ç§»..."
          python manage.py showmigrations
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆ›å»ºçš„è¿ç§»
          python manage.py makemigrations --check --verbosity 2
          
          # æ‰§è¡Œè¿ç§»
          python manage.py migrate --verbosity 2
          
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
          
      - name: è¿è¡ŒDjangoæµ‹è¯•
        if: matrix.test-type != 'docker'
        env:
          DJANGO_MYSQL_PASSWORD: root
          DJANGO_MYSQL_HOST: 127.0.0.1
          DJANGO_ELASTICSEARCH_HOST: ${{ matrix.elasticsearch && 'http://127.0.0.1:9200' || '' }}
        run: |
          echo "ğŸ§ª å¼€å§‹æ‰§è¡Œ ${{ matrix.test-type }} æµ‹è¯• (Python ${{ matrix.python-version }})"
          
          # æ˜¾ç¤ºDjangoé…ç½®ä¿¡æ¯
          python manage.py diffsettings | head -20
          
          # è¿è¡Œæµ‹è¯•
          if [ "${{ matrix.coverage }}" = "true" ]; then
            echo "ğŸ“Š è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
            coverage run --source='.' --omit='*/venv/*,*/migrations/*,*/tests/*,manage.py' manage.py test --verbosity=2
            
            echo "ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
            coverage xml
            coverage report --show-missing
            coverage html
            
            echo "ğŸ“‹ è¦†ç›–ç‡ç»Ÿè®¡:"
            coverage report | tail -1
          else
            echo "ğŸ§ª è¿è¡Œæ ‡å‡†æµ‹è¯•"
            python manage.py test --verbosity=2 --failfast
          fi
          
          echo "âœ… æµ‹è¯•æ‰§è¡Œå®Œæˆ"
          
      # è¦†ç›–ç‡æŠ¥å‘Šä¸Šä¼  (åªæœ‰å®Œæ•´æµ‹è¯•æ‰æ‰§è¡Œ)
      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
        if: matrix.coverage == true && success()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ steps.test-info.outputs.test_name }}
          fail_ci_if_error: false
          verbose: true
          
      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov (å¤‡ç”¨)
        if: matrix.coverage == true && failure()
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ steps.test-info.outputs.test_name }}-fallback
          fail_ci_if_error: false
          verbose: true
          
      # Dockeræ„å»ºæµ‹è¯•
      - name: è®¾ç½®QEMU
        if: matrix.test-type == 'docker'
        uses: docker/setup-qemu-action@v3
        
      - name: è®¾ç½®Docker Buildx
        if: matrix.test-type == 'docker'
        uses: docker/setup-buildx-action@v3
        
      - name: Dockeræ„å»ºæµ‹è¯•
        if: matrix.test-type == 'docker'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: djangoblog/djangoblog:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      # æ”¶é›†æµ‹è¯•å·¥ä»¶ (å¤±è´¥æ—¶æ”¶é›†è°ƒè¯•ä¿¡æ¯)
      - name: æ”¶é›†æµ‹è¯•å·¥ä»¶
        if: failure() && matrix.test-type != 'docker'
        run: |
          echo "ğŸ” æ”¶é›†æµ‹è¯•å¤±è´¥çš„è°ƒè¯•ä¿¡æ¯"
          
          # æ”¶é›†Djangoæ—¥å¿—
          if [ -d "logs" ]; then
            echo "ğŸ“„ Djangoæ—¥å¿—æ–‡ä»¶:"
            ls -la logs/
            if [ -f "logs/djangoblog.log" ]; then
              echo "ğŸ” æœ€æ–°æ—¥å¿—å†…å®¹:"
              tail -100 logs/djangoblog.log
            fi
          fi
          
          # æ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€
          echo "ğŸ—„ï¸ æ•°æ®åº“è¿æ¥çŠ¶æ€:"
          python -c "
          try:
              from django.db import connection
              cursor = connection.cursor()
              cursor.execute('SELECT VERSION()')
              print(f'MySQLç‰ˆæœ¬: {cursor.fetchone()[0]}')
              cursor.execute('SHOW TABLES')
              tables = cursor.fetchall()
              print(f'æ•°æ®åº“è¡¨æ•°é‡: {len(tables)}')
          except Exception as e:
              print(f'æ•°æ®åº“è¿æ¥é”™è¯¯: {e}')
          " || true
          
          # ElasticsearchçŠ¶æ€ (å¦‚æœå¯ç”¨)
          if [ "${{ matrix.elasticsearch }}" = "true" ]; then
            echo "ğŸ” ElasticsearchçŠ¶æ€:"
            curl -s http://127.0.0.1:9200/_cluster/health?pretty || true
          fi
          
      # ä¸Šä¼ æµ‹è¯•å·¥ä»¶
      - name: ä¸Šä¼ è¦†ç›–ç‡HTMLæŠ¥å‘Š
        if: matrix.coverage == true && always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report-${{ steps.test-info.outputs.test_name }}
          path: htmlcov/
          retention-days: 30
          
      # æ€§èƒ½ç»Ÿè®¡
      - name: æµ‹è¯•æ€§èƒ½ç»Ÿè®¡
        if: always() && matrix.test-type != 'docker'
        run: |
          echo "âš¡ æµ‹è¯•æ€§èƒ½ç»Ÿè®¡:"
          echo "   å¼€å§‹æ—¶é—´: $(date -d '@${{ job.started_at }}' '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo 'æœªçŸ¥')"
          echo "   å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
          echo "ğŸ’» ç³»ç»Ÿèµ„æº:"
          echo "   CPUä½¿ç”¨: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)%"
          echo "   å†…å­˜ä½¿ç”¨: $(free -h | awk '/^Mem:/ {printf "%.1f%%", $3/$2 * 100}')"
          echo "   ç£ç›˜ä½¿ç”¨: $(df -h / | awk 'NR==2{printf "%s", $5}')"
          
      # æµ‹è¯•ç»“æœæ±‡æ€»
      - name: æµ‹è¯•å®Œæˆæ€»ç»“
        if: always()
        run: |
          echo "ğŸ“‹ ============ æµ‹è¯•æ‰§è¡Œæ€»ç»“ ============"
          echo "   ğŸ·ï¸  æµ‹è¯•ç±»å‹: ${{ matrix.test-type }}"
          echo "   ğŸ Pythonç‰ˆæœ¬: ${{ matrix.python-version }}"
          echo "   ğŸ—„ï¸  æ•°æ®åº“: ${{ matrix.database }}"
          echo "   ğŸ” Elasticsearch: ${{ matrix.elasticsearch }}"
          echo "   ğŸ“Š è¦†ç›–ç‡: ${{ matrix.coverage }}"
          echo "   âš¡ çŠ¶æ€: ${{ job.status }}"
          echo "   ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "============================================"
          
          # æ ¹æ®æµ‹è¯•ç»“æœæ˜¾ç¤ºä¸åŒæ¶ˆæ¯
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ æµ‹è¯•æ‰§è¡ŒæˆåŠŸï¼"
          else
            echo "âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„æ—¥å¿—"
          fi
